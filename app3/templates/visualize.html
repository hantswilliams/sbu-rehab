<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Pose Data Visualization</title>
  <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
  <script type="text/javascript">
    google.charts.load('current', {'packages':['corechart']});
    google.charts.setOnLoadCallback(drawCharts);

    async function fetchData() {
      const response = await fetch('/get_pose_data');
      const data = await response.json();
      return data;
    }

    async function drawCharts() {
      const rawData = await fetchData();
      const exerciseData = {};

      rawData.forEach(item => {
        const [timestamp, angle, exercise, count, test_uuid] = item;
        const uuidCount = `${test_uuid}_${count}`;
        if (!exerciseData[exercise]) {
          exerciseData[exercise] = [['Timestamp', 'Angle']];
        }
        exerciseData[exercise].push([new Date(timestamp), angle]);
      });

      drawExerciseCharts(exerciseData);
    }

    function drawExerciseCharts(exerciseData) {
      document.getElementById('charts').innerHTML = '';

      Object.keys(exerciseData).forEach(exercise => {
        const dataArray = exerciseData[exercise];

        if (dataArray.length > 1) { // Only draw chart if there's data


          const data = google.visualization.arrayToDataTable(dataArray);

          const options = {
            title: `Range of Motion Over Time - ${exercise}`,
            hAxis: { title: 'Time' },
            vAxis: { title: 'Angle (degrees)' },
            interpolateNulls: true
          };

          const chartDiv = document.createElement('div');
          chartDiv.style.width = '100%';
          chartDiv.style.height = '500px';
          document.getElementById('charts').appendChild(chartDiv);

          const chart = new google.visualization.LineChart(chartDiv);
          chart.draw(data, options);
        }
      });
    }

    document.addEventListener('DOMContentLoaded', () => {
      drawCharts(); // Initial call to draw charts with all data
    });
  </script>
</head>
<body>
  <div id="charts"></div>
</body>
</html>
