<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Watch Videos</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    .video-container {
      margin-top: 20px;
    }
    .data-output {
      margin-top: 20px;
      font-size: 18px;
      font-weight: bold;
      color: #333;
      border: 1px solid #ddd;
      padding: 10px;
      background-color: #fff;
      border-radius: 5px;
      width: 640px; /* Adjust to match the video width */
    }
    .metadata {
      margin-top: 10px;
      font-size: 16px;
      color: #555;
    }
    .chart-container {
      width: 640px; /* Adjust to match the video width */
      margin-top: 20px;
    }
    .loading {
      font-size: 24px;
      font-weight: bold;
      color: #333;
      margin-top: 20px;
    }
  </style>
</head>
<body class="bg-gray-100 flex flex-col items-center justify-center h-screen">
  <div class="mb-4">
    <label for="video-selector" class="block text-gray-700">Select Video:</label>
    <select id="video-selector" class="border border-gray-300 p-2 rounded">
      <option value="" disabled selected>Select an option!</option>
      <!-- Videos will be populated here -->
    </select>
  </div>
  <div id="loading-indicator" class="loading" style="display: none;">Loading...</div>
  <div class="video-container">
    <video id="video-player" class="border border-gray-300 rounded mb-4" width="640" height="480" controls></video>
  </div>
  <div class="data-output">
    <div id="angle-output">Angle: N/A</div>
    <div id="metadata" class="metadata"></div>
  </div>
  <div class="chart-container">
    <canvas id="angle-chart"></canvas>
  </div>
  <script>
    let videoPlayer;
    let videoMetadata = [];
    let angleChart;
    let chartData = [];

    async function populateVideoSelector() {
      const response = await fetch('/videos');
      const videos = await response.json();
      const videoSelector = document.getElementById('video-selector');
      videos.forEach(video => {
        const option = document.createElement('option');
        option.value = video.id;
        option.text = video.name;
        videoSelector.appendChild(option);
      });
    }

    async function fetchVideoData(videoId) {
      const response = await fetch(`/video_metadata/${videoId}`);
      videoMetadata = await response.json();
      return videoMetadata;
    }

    function updateAngleOutput(currentTime) {
      const angleOutput = document.getElementById('angle-output');
      let currentAngle = 'N/A';

      // Normalize currentTime to frame index
      const frameIndex = Math.floor((currentTime / videoPlayer.duration) * videoMetadata.pose_data.length);
      if (frameIndex >= 0 && frameIndex < videoMetadata.pose_data.length) {
        currentAngle = videoMetadata.pose_data[frameIndex][0];
      }

      console.log('Current Time:', currentTime, 'Current Angle:', currentAngle, 'Frame Index:', frameIndex);

      angleOutput.textContent = `Angle: ${currentAngle}`;
      updateChart(frameIndex);
    }

    function updateMetadata(metadata) {
      const metadataDiv = document.getElementById('metadata');
      metadataDiv.innerHTML = `
        <div>User: ${metadata.user_name}</div>
        <div>Session UUID: ${metadata.test_uuid}</div>
        <div>Movement Count: ${metadata.movement_count}</div>
        <div>Exercise: ${metadata.exercise}</div>
      `;
    }

    function updateChart(frameIndex) {
      if (angleChart) {
        angleChart.data.datasets[1].data = chartData.map((_, index) => index === frameIndex ? chartData[index] : null);
        angleChart.update();
      }
    }

    function initializeChart(poseData) {
      const ctx = document.getElementById('angle-chart').getContext('2d');
      const labels = poseData.map((_, index) => index);
      chartData = poseData.map(row => row[0]);

      if (angleChart) {
        angleChart.destroy();
      }

      angleChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: labels,
          datasets: [{
            label: 'Angle',
            data: chartData,
            borderColor: 'rgba(75, 192, 192, 1)',
            borderWidth: 1,
            fill: false
          }, {
            label: 'Current Frame',
            data: Array(chartData.length).fill(null),
            borderColor: 'rgba(255, 99, 132, 1)',
            borderWidth: 2,
            pointRadius: 5,
            fill: false,
            showLine: false
          }]
        },
        options: {
          animation: {
            duration: 0 // Disable animation for real-time updates
          },
          scales: {
            x: {
              title: {
                display: true,
                text: 'Frame'
              }
            },
            y: {
              title: {
                display: true,
                text: 'Angle (degrees)'
              },
              min: 0,
              max: 180
            }
          }
        }
      });
    }

    document.addEventListener('DOMContentLoaded', () => {
      videoPlayer = document.getElementById('video-player');

      populateVideoSelector();

      document.getElementById('video-selector').addEventListener('change', async () => {
        const videoId = document.getElementById('video-selector').value;

        // Show loading indicator
        document.getElementById('loading-indicator').style.display = 'block';

        // Preload video and metadata
        const metadata = await fetchVideoData(videoId);
        updateMetadata(metadata);
        initializeChart(metadata.pose_data);

        // Set video source and preload
        videoPlayer.src = `/video/${videoId}`;
        videoPlayer.load();

        // Wait for video metadata to be loaded
        videoPlayer.addEventListener('loadedmetadata', () => {
          document.getElementById('loading-indicator').style.display = 'none'; // Hide loading indicator

          videoPlayer.addEventListener('timeupdate', () => {
            const currentTime = videoPlayer.currentTime;
            updateAngleOutput(currentTime);
          });

          videoPlayer.currentTime = 0;
          videoPlayer.play().then(() => {
            videoPlayer.pause();
          });
        }, { once: true });
      });
    });
  </script>
</body>
</html>
